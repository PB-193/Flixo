#!/bin/bash

# Flixo ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

print_header() {
    echo -e "${PURPLE}"
    echo "ğŸ“Š =========================================="
    echo "   Flixo ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
    echo "==========================================${NC}"
    echo ""
}

print_section() {
    echo -e "${CYAN}ğŸ”§ $1${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# JSONã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
extract_test_stats() {
    local json_file="$1"
    
    if [ ! -f "$json_file" ]; then
        print_error "ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $json_file"
        return 1
    fi
    
    # Node.jsã‚’ä½¿ã£ã¦JSONã‚’è§£æ
    node -e "
        const fs = require('fs');
        const data = JSON.parse(fs.readFileSync('$json_file', 'utf8'));
        const stats = data.stats || {};
        console.log('Total:', stats.expected || 0);
        console.log('Passed:', stats.passed || 0);
        console.log('Failed:', stats.failed || 0);
        console.log('Skipped:', stats.skipped || 0);
        console.log('Duration:', Math.round((stats.duration || 0) / 1000) + 's');
    "
}

# ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆã®ç”Ÿæˆ
generate_screenshot_stats() {
    local test_results_dir="test-results"
    
    if [ ! -d "$test_results_dir" ]; then
        print_error "ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        return 1
    fi
    
    local png_count=$(find "$test_results_dir" -name "*.png" 2>/dev/null | wc -l)
    local jpg_count=$(find "$test_results_dir" -name "*.jpg" 2>/dev/null | wc -l)
    local total_screenshots=$((png_count + jpg_count))
    
    echo "ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆ:"
    echo "  PNG: $png_count å€‹"
    echo "  JPG: $jpg_count å€‹"
    echo "  åˆè¨ˆ: $total_screenshots å€‹"
}

# ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
generate_markdown_report() {
    local output_file="TEST_EXECUTION_REPORT.md"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    print_section "Markdownãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
    
    cat > "$output_file" << EOF
# ğŸ“Š Flixo ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

**ç”Ÿæˆæ—¥æ™‚**: $timestamp

## ğŸ¯ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼

EOF

    # JSONçµæœãŒã‚ã‚Œã°çµ±è¨ˆã‚’è¿½åŠ 
    if [ -f "test-results/results.json" ]; then
        echo "### ãƒ†ã‚¹ãƒˆçµ±è¨ˆ" >> "$output_file"
        echo '```' >> "$output_file"
        extract_test_stats "test-results/results.json" >> "$output_file"
        echo '```' >> "$output_file"
        echo "" >> "$output_file"
    fi
    
    # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆ
    echo "### ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆçµ±è¨ˆ" >> "$output_file"
    echo '```' >> "$output_file"
    generate_screenshot_stats >> "$output_file"
    echo '```' >> "$output_file"
    echo "" >> "$output_file"
    
    # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
    echo "### å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«" >> "$output_file"
    echo "" >> "$output_file"
    for test_file in tests/*.spec.ts; do
        if [ -f "$test_file" ]; then
            echo "- \`$(basename "$test_file")\`" >> "$output_file"
        fi
    done
    echo "" >> "$output_file"
    
    # ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
    echo "### ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ" >> "$output_file"
    echo "" >> "$output_file"
    
    # ä¸»è¦ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤º
    local key_screenshots=(
        "main-page-full.png"
        "desktop-1920x1080.png"
        "mobile-375x667.png"
        "video-post-form.png"
        "card-hover-after.png"
    )
    
    for screenshot in "${key_screenshots[@]}"; do
        if [ -f "test-results/$screenshot" ]; then
            echo "#### $(basename "$screenshot" .png | tr '-' ' ' | sed 's/\b\w/\U&/g')" >> "$output_file"
            echo "![$(basename "$screenshot")]](test-results/$screenshot)" >> "$output_file"
            echo "" >> "$output_file"
        fi
    done
    
    # ãƒ•ãƒƒã‚¿ãƒ¼
    cat >> "$output_file" << EOF

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [HTML ãƒ¬ãƒãƒ¼ãƒˆ](playwright-report/index.html)
- [JSON çµæœ](test-results/results.json)
- [ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª](test-results/)

---

**Generated by Flixo Test Suite** âœ¨
EOF
    
    print_success "Markdownãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ: $output_file"
}

# HTMLã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
generate_html_summary() {
    local output_file="test-summary.html"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    print_section "HTMLã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆä¸­..."
    
    cat > "$output_file" << 'EOF'
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flixo ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f6f9fc, #ffffff);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3B82F6;
        }
        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .screenshots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .screenshot-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        .screenshot-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .screenshot-card h3 {
            padding: 15px;
            margin: 0;
            background: #f8fafc;
            color: #374151;
            font-size: 1rem;
        }
        .button {
            display: inline-block;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            margin: 10px;
            transition: transform 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ Flixo ãƒ†ã‚¹ãƒˆã‚µãƒãƒªãƒ¼</h1>
            <p>Generated on: TIMESTAMP_PLACEHOLDER</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="total-tests">-</div>
                <div class="stat-label">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="passed-tests">-</div>
                <div class="stat-label">æˆåŠŸ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failed-tests">-</div>
                <div class="stat-label">å¤±æ•—</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="screenshots">-</div>
                <div class="stat-label">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</div>
            </div>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <a href="playwright-report/index.html" class="button">ğŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹</a>
            <a href="test-results/" class="button">ğŸ“ ãƒ†ã‚¹ãƒˆçµæœã‚’è¦‹ã‚‹</a>
        </div>
        
        <h2>ğŸ“¸ ä¸»è¦ãªã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</h2>
        <div class="screenshots" id="screenshots-container">
            <!-- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
        </div>
    </div>
    
    <script>
        // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        // ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®å®Ÿè¡Œæ™‚ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™
    </script>
</body>
</html>
EOF

    # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç½®æ›
    sed -i '' "s/TIMESTAMP_PLACEHOLDER/$timestamp/g" "$output_file"
    
    print_success "HTMLã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¾ã—ãŸ: $output_file"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    print_header
    
    # ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
    if [ ! -d "test-results" ]; then
        print_error "test-results ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        print_info "å…ˆã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„: ./scripts/test.sh"
        exit 1
    fi
    
    # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    generate_markdown_report
    generate_html_summary
    
    print_section "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
    print_success "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
    print_info "  - TEST_EXECUTION_REPORT.md (Markdown ãƒ¬ãƒãƒ¼ãƒˆ)"
    print_info "  - test-summary.html (HTML ã‚µãƒãƒªãƒ¼)"
    print_info "  - playwright-report/index.html (è©³ç´° HTML ãƒ¬ãƒãƒ¼ãƒˆ)"
    
    echo ""
    print_info "HTMLã‚µãƒãƒªãƒ¼ã‚’é–‹ãã«ã¯: open test-summary.html"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"